#!/bin/bash

#--------------------------------------------------------------------
# Script for timed restart of docker container in crone
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ crontab ->
# - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä CONTAINER_NAME –∏
# - –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∏ LOG_FILE
# Tested on Ubuntu 24.04.1 LTS
# Developed by Olga Shkola in 2025
#--------------------------------------------------------------------

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞:
# –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# CONTAINER_NAME="<container_name>"
# –ü—É—Ç—å –¥–æ LOG_FILE
# LOG_FILE="/path/to/logs/"
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ->
# CONFIG_FILE

# –í—Ä–µ–º—è –∑–∞–¥–µ—Ä–∂–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ telegram
# –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 2 —á–∞—Å–∞ (7200 —Å–µ–∫—É–Ω–¥)
# –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 2,5 —á–∞—Å–∞ (9000 —Å–µ–∫—É–Ω–¥)
# –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 3 —á–∞—Å–∞ (10800 —Å–µ–∫—É–Ω–¥)


TIME_SLEEP=10800
TIME_SLEEP_MESSAGE=3
TIME_SLEEP_ERROR=7200

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞
if [ "$#" -ne 1 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 –ø—É—Ç—å_–∫_–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É_—Ñ–∞–π–ª—É" >&2
    exit 1
fi

CONFIG_FILE="$1"

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "$CONFIG_FILE" ]; then
    . "$CONFIG_FILE"
else
    echo "–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ $CONFIG_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω." >&2
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
: "${TELEGRAM_TOKEN:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TELEGRAM_CHAT_ID:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TIMESTAMP_HOST_FILE:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TIMESTAMP_HOST_FILE –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TIME_DELTA:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TIME_DELTA –Ω–µ –∑–∞–¥–∞–Ω–∞}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
send_telegram_message() {
    local message="$1"
    local url="https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage"
    curl -s -X POST "$url" -d "chat_id=$TELEGRAM_CHAT_ID&text=$message"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
log_with_timestamp() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
if docker restart "$CONTAINER_NAME"; then
    message="‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$CONTAINER_NAME' —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.‚úàÔ∏è "
    log_with_timestamp "$message"

    # –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 3 —á–∞—Å–∞ (10800 —Å–µ–∫—É–Ω–¥)
    sleep $TIME_SLEEP

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
    message="‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$CONTAINER_NAME' –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω ‚úàÔ∏è  –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —É–∂–µ $TIME_SLEEP_MESSAGE —á–∞—Å–∞."
    log_with_timestamp "$message"
    send_telegram_message "$message" &  # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

else
    message="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$CONTAINER_NAME'.ü§¨"
    log_with_timestamp "$message"

    # –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 2 —á–∞—Å–∞ (7200 —Å–µ–∫—É–Ω–¥)
    sleep $TIME_SLEEP_ERROR

    send_telegram_message "$message" &  # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
fi
