#!/bin/bash

#--------------------------------------------------------------------
# Script to check Cartman Project audit
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É–¥–∏—Ç–∞ ->
# - –ø–æ–ª—É—á–∞–µ—Ç –≤—Ä–µ–º—è —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞,
# - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª –±—ã–ª —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –Ω–µ –ø–æ–∑–¥–Ω–µ–µ TIME_DELTA,
# - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ telegram-–∫–∞–Ω–∞–ª
# Tested on Ubuntu 24.04.1 LTS
# Developed by Olga Shkola in 2025
#--------------------------------------------------------------------

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞:
# –¢–æ–∫–µ–Ω –∏ ID —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–∞ ->
# TELEGRAM_TOKEN
# TELEGRAM_CHAT_ID
# –ò–º—è –∏ –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞, –≥–¥–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
# —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∞—É–¥–∏—Ç–µ ->
# TIMESTAMP_HOST_FILE
# –í—Ä–µ–º—è, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ –∏—â–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∞—É–¥–∏—Ç–µ ->
# TIME_DELTA
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# CONFIG_FILE


# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞
if [ "$#" -ne 1 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 –ø—É—Ç—å_–∫_–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É_—Ñ–∞–π–ª—É" >&2
    exit 1
fi

CONFIG_FILE="$1"

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "$CONFIG_FILE" ]; then
    . "$CONFIG_FILE"
else
    echo "–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ $CONFIG_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω." >&2
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
: "${TELEGRAM_TOKEN:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TELEGRAM_CHAT_ID:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TIMESTAMP_HOST_FILE:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TIMESTAMP_HOST_FILE –Ω–µ –∑–∞–¥–∞–Ω–∞}"
: "${TIME_DELTA:?–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TIME_DELTA –Ω–µ –∑–∞–¥–∞–Ω–∞}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
send_telegram_warning_message() {
    local message="$1"
    local url="https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage"
    curl -s -X POST "$url" -d "chat_id=$TELEGRAM_CHAT_ID&text=$message"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
if [ ! -f "$TIMESTAMP_HOST_FILE" ]; then
    send_telegram_warning_message "‚ùå FATAL!!! ü§¨ –§–∞–π–ª $TIMESTAMP_HOST_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω."
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
last_modified_time=$(stat -c %Y "$TIMESTAMP_HOST_FILE")
current_time=$(date +%s)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
if (( (current_time - last_modified_time) > (TIME_DELTA * 3600) )); then
    send_telegram_warning_message "‚ùå FATAL!!! ü§¨ –ù–µ –±—ã–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Ä–∞–±–æ—Ç–µ –≥—Ä–∞–±–±–µ—Ä–æ–≤ –∑–∞ $TIME_DELTA —á."
    exit 1
fi

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏—Ç–∞ –≥—Ä–∞–±–±–µ—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –°–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã."
send_telegram_warning_message "‚úÖ  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏—Ç–∞ –≥—Ä–∞–±–±–µ—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ. –°–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.‚úàÔ∏è "
